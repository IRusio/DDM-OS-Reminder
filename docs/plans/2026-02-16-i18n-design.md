# Internationalization (i18n) Feature Design

**Date:** 2026-02-16
**Version:** 1.0
**Status:** Approved

## Overview

Add internationalization support to DDM OS Reminder to automatically adjust user-facing prompts, messages, and UI text based on the language configured on the user's Mac. The system will auto-detect the system language, load appropriate translations, and fall back gracefully to English when translations are unavailable.

## Requirements

- Auto-detect language from macOS system preferences
- Support English and Polish translations at launch
- Store translations in separate, maintainable language files
- Fall back to English with warning logging for missing translations
- Allow MDM administrators to override translations via existing plist mechanism
- Maintain backward compatibility with current configuration system

## Architecture

### Layered Translation System

The i18n implementation uses a three-layer priority system:

1. **Base translations** - Language-specific `.zsh` files in `locales/` directory
2. **Language detection** - Automatic detection at script startup via `AppleLocale`
3. **Plist overrides** - MDM/admin overrides applied on top (existing functionality preserved)

**Priority Order:**
- **Highest:** MDM/plist overrides (for custom organizational messaging)
- **Medium:** Language file translations
- **Lowest:** Hardcoded defaults in `preferenceConfiguration`

### Directory Structure

```
DDM-OS-Reminder/
├── locales/
│   ├── en.zsh          # English translations (base/fallback)
│   ├── pl.zsh          # Polish translations
│   └── README.md       # Guide for adding new languages
├── reminderDialog.zsh  # Main script (modified)
├── assemble.zsh        # Build script (modified to include locales)
└── docs/
    └── plans/
        └── 2026-02-16-i18n-design.md  # This document
```

### Language File Format

Each language file defines a single associative array with all translatable strings:

```zsh
#!/bin/zsh
# Polish translations for DDM OS Reminder

declare -A translations=(
    ["title"]="Wymagana aktualizacja macOS {titleMessageUpdateOrUpgrade}"
    ["button1text"]="Otwórz Aktualizację Oprogramowania"
    ["button2text"]="Przypomnij Mi Później"
    ["infobuttontext"]="Zaktualizuj macOS na Mac"
    # ... all other translatable strings
)
```

## Components

### 1. Language Detection

**Function:** `loadTranslations()`

**Logic:**
1. Read system language: `defaults read -g AppleLocale` (returns "en_US", "pl_PL", etc.)
2. Extract language code (first 2 characters): "en", "pl", "de"
3. Check if translation file exists: `locales/{lang}.zsh`
4. If found, source it; if not found, fall back to English and log notice

### 2. Translation Loading & Merging

**Process:**
1. Load English translations as baseline (always available)
2. If target language is not English:
   - Load target language file
   - Compare against English to detect missing keys
   - Fill missing keys with English values
   - Log warning for each missing translation
3. Merge all translations into `preferenceConfiguration` array
4. Apply existing plist overrides via `loadPreferenceOverrides()`

**Code Flow:**
```zsh
function loadTranslations() {
    local systemLocale=$(defaults read -g AppleLocale 2>/dev/null || echo "en_US")
    local langCode="${systemLocale:0:2}"
    local scriptDirectory="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    local langFile="${scriptDirectory}/locales/${langCode}.zsh"

    # Load English baseline
    source "${scriptDirectory}/locales/en.zsh"
    declare -A englishTranslations=("${(@kv)translations}")

    # Load target language if not English
    if [[ "${langCode}" != "en" && -f "${langFile}" ]]; then
        source "${langFile}"
        info "Loaded translations for language: ${langCode}"

        # Check for missing translations
        for key in "${(@k)englishTranslations}"; do
            if [[ -z "${translations[$key]}" ]]; then
                warning "Missing translation for '${key}' in ${langCode}, using English"
                translations[$key]="${englishTranslations[$key]}"
            fi
        done
    else
        if [[ "${langCode}" != "en" ]]; then
            notice "Language '${langCode}' not available, using English"
        fi
    fi

    # Merge translations into preferenceConfiguration
    for key in "${(@k)translations}"; do
        preferenceConfiguration[$key]="string|${translations[$key]}"
    done
}
```

### 3. MDM/Plist Override Integration

**Behavior:**
- Existing `loadPreferenceOverrides()` function requires no changes
- Plist overrides apply **after** language translations load
- Administrators can override any message regardless of detected language
- Current customization workflows remain unchanged

**Future Enhancement (Optional):**
Language-specific plist keys could be added (e.g., `TitlePL`, `TitleEN`) for per-language overrides, but this is not included in initial implementation.

## Error Handling

### Missing Language File
- **Action:** Fall back to English
- **Logging:** `notice "Language 'XX' not available, using English"`
- **User Impact:** None (sees English instead)

### Missing Translation Key
- **Action:** Use English value for that specific key
- **Logging:** `warning "Missing translation for 'key' in XX, using English"`
- **User Impact:** Sees English for specific message, rest in target language

### System Locale Detection Failure
- **Action:** Default to `en_US`
- **Logging:** Error captured by `defaults read` redirect to `/dev/null`
- **User Impact:** None (sees English)

### Variable Placeholder Mismatch
- **Detection:** Validation script checks for placeholder consistency
- **Prevention:** Translation guidelines emphasize preserving placeholders
- **Runtime:** No special handling (renders as-is if mismatched)

## Testing

### 1. Demo Mode Enhancement
Extend existing demo mode to accept language parameter:
```bash
zsh reminderDialog.zsh demo           # Uses system language
zsh reminderDialog.zsh demo pl        # Forces Polish
zsh reminderDialog.zsh demo en        # Forces English
```

### 2. Validation Script
Create `locales/validate-translations.zsh` to check:
- All required keys present in each language file
- No orphaned/extra keys
- Variable placeholders preserved correctly (e.g., `{ddmVersionString}`)
- Run during assembly process

### 3. Manual Testing Checklist
- [ ] Test on Mac with `AppleLocale` set to `en_US`
- [ ] Test on Mac with `AppleLocale` set to `pl_PL`
- [ ] Test on Mac with unsupported language (e.g., `de_DE`)
- [ ] Verify fallback to English when language file missing
- [ ] Confirm plist overrides work correctly with Polish language
- [ ] Check log file for missing translation warnings
- [ ] Verify all variable substitutions work in both languages

### 4. Assemble Script Updates
Modify `assemble.zsh` to:
- Include `locales/` directory in assembled artifact
- Run translation validation before assembly
- Package language files correctly for deployment

## Documentation

### locales/README.md
Create comprehensive guide including:
- Instructions for adding new languages
- Complete list of translatable keys
- Guidelines for maintaining translations
- Variable placeholder documentation
- Example of creating a new language file
- How to test new translations

### Main README.md Updates
Add section describing:
- Supported languages
- How language detection works
- How to add new languages
- MDM override behavior with i18n

## Implementation Order

1. Create `locales/` directory structure
2. Extract all English strings into `locales/en.zsh`
3. Create `locales/pl.zsh` with Polish translations
4. Implement `loadTranslations()` function in `reminderDialog.zsh`
5. Update `assemble.zsh` to include locale files
6. Create validation script
7. Enhance demo mode to accept language parameter
8. Write documentation (`locales/README.md`)
9. Update main `README.md`
10. Test thoroughly with both languages

## Future Enhancements

### Short-term
- Add more languages (German, Spanish, French, etc.)
- Per-language plist override keys
- Language selection via command-line parameter

### Long-term
- Regional variations (e.g., en_GB vs en_US)
- Date format localization
- Number format localization
- Timezone-aware deadline displays

## Success Criteria

- Users see messages in their Mac's configured language
- Missing translations fall back gracefully to English
- Admins can still override messages via plists
- No breaking changes to existing deployments
- Clean warnings in logs for incomplete translations
- Easy for contributors to add new languages
